<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حفظ البيانات في Firestore</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* تعيين خط Inter وبعض الأنماط الأساسية */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
    </style>
</head>
<body>

    <div class="max-w-4xl mx-auto p-6 md:p-10">
        <!-- البطاقة الرئيسية للتطبيق -->
        <div class="bg-white shadow-2xl rounded-xl p-6 lg:p-8">
            <h1 class="text-3xl font-extrabold text-blue-800 mb-4 border-b pb-2">💾 حفظ بيانات المستخدم (Firestore)</h1>
            <p class="text-gray-600 mb-6">هذا التطبيق يوضح كيفية حفظ البيانات الخاصة بك في Firestore واسترجاعها في الوقت الفعلي.</p>

            <!-- حالة التحميل والخطأ -->
            <div id="loading-message" class="bg-yellow-100 border-r-4 border-yellow-500 text-yellow-700 p-4 rounded mb-6 hidden">
                جاري تهيئة Firebase وتسجيل الدخول...
            </div>
            <!-- تم إخفاء رسالة الخطأ الافتراضية عند البدء -->
            <div id="error-message" class="bg-red-100 border-r-4 border-red-500 text-red-700 p-4 rounded mb-6 hidden">
                حدث خطأ في التهيئة أو الاتصال.
            </div>

            <!-- عرض معلومات المستخدم -->
            <div id="user-info-section" class="bg-blue-50 p-4 rounded-lg mb-8 shadow-inner hidden">
                <p class="text-sm font-semibold text-blue-700 mb-2">معلومات الحساب:</p>
                <p class="text-xs break-all">
                    <span class="font-bold text-gray-700">معرّف التطبيق (App ID):</span> <span id="app-id-display" class="font-mono text-gray-600"></span>
                </p>
                <p class="text-xs break-all">
                    <span class="font-bold text-gray-700">معرّف المستخدم (User ID):</span> <span id="user-id-display" class="font-mono text-gray-600"></span>
                </p>
            </div>

            <!-- قسم حفظ البيانات -->
            <h2 class="text-2xl font-bold text-gray-800 mb-4">أدخل بياناتك:</h2>
            <div class="space-y-4">
                <div>
                    <label for="userName" class="block text-sm font-medium text-gray-700">الاسم:</label>
                    <input type="text" id="userName" placeholder="أدخل اسمك هنا"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-blue-500 focus:ring-blue-500 transition duration-150">
                </div>
                <div>
                    <label for="userEmail" class="block text-sm font-medium text-gray-700">البريد الإلكتروني:</label>
                    <input type="email" id="userEmail" placeholder="أدخل بريدك الإلكتروني"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-blue-500 focus:ring-blue-500 transition duration-150">
                </div>
                <button id="saveButton"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 transform hover:scale-[1.01]"
                        disabled>
                    حفظ البيانات
                </button>
            </div>

            <!-- قسم البيانات المحفوظة -->
            <h2 class="text-2xl font-bold text-gray-800 mt-10 mb-4">البيانات المحفوظة حاليًا (تحديث تلقائي):</h2>
            <div id="saved-data-card" class="bg-green-50 p-6 rounded-xl border border-green-300 shadow-md">
                <p id="savedName" class="text-lg font-semibold text-gray-800 mb-2">الاسم المحفوظ: <span class="text-green-700 font-bold">... لا يوجد بيانات ...</span></p>
                <p id="savedEmail" class="text-lg font-semibold text-gray-800">البريد المحفوظ: <span class="text-green-700 font-bold">... لا يوجد بيانات ...</span></p>
            </div>

        </div>
    </div>

    <!-- Custom Modal for Alerts/Errors (Replaces alert()) -->
    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full transform transition-all">
            <h3 id="modalTitle" class="text-xl font-bold mb-3 text-gray-800"></h3>
            <p id="modalMessage" class="text-gray-600 mb-6"></p>
            <button id="modalCloseButton" class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                حسناً
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // === تم تحديث الإعدادات هنا باستخدام البيانات التي قدمتها لمشروع kawther2 ===
        // =========================================================================
        
        // إعدادات مشروعك الحقيقية
        const firebaseConfigManual = {
            apiKey: "AIzaSyA3kHexcWgAh_7jqHbgWp-QX8Nj5bFb9s8",
            authDomain: "kawther2.firebaseapp.com",
            projectId: "kawther2",
            storageBucket: "kawther2.firebasestorage.app",
            messagingSenderId: "497467173741",
            appId: "1:497467173741:web:6450bd989d8ce273338864",
            measurementId: "G-W5LE13JCYG" // Measurement ID is optional for initialization
        };
        
        // متغيرات البيئة الخاصة بـ Canvas (يتم استخدامها إذا توفرت، وإلا يتم استخدام الإعدادات اليدوية)
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfigManual.projectId; 
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfigManual;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;

        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const saveButton = document.getElementById('saveButton');
        const appIdDisplay = document.getElementById('app-id-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const userInfoSection = document.getElementById('user-info-section');
        const savedNameDisplay = document.getElementById('savedName').querySelector('span');
        const savedEmailDisplay = document.getElementById('savedEmail').querySelector('span');
        
        // Modal Elements
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseButton = document.getElementById('modalCloseButton');

        // Function to show the custom modal (replaces alert)
        function showModal(title, message, isError = false) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            // Customize style based on error status
            if (isError) {
                modalTitle.classList.remove('text-gray-800');
                modalTitle.classList.add('text-red-600');
                modalCloseButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                modalCloseButton.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                modalTitle.classList.remove('text-red-600');
                modalTitle.classList.add('text-gray-800');
                modalCloseButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                modalCloseButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }

            customModal.classList.remove('hidden');
        }

        function hideModal() {
            customModal.classList.add('hidden');
        }
        
        // Attach listener to close button
        modalCloseButton.addEventListener('click', hideModal);


        // --- 1. INITIALIZATION AND AUTHENTICATION ---
        async function initializeFirebase() {
            loadingMessage.textContent = "جاري تهيئة Firebase...";
            loadingMessage.classList.remove('hidden');

            // التحقق مما إذا كانت إعدادات Firebase مفقودة أو وهمية
            if (!firebaseConfig || firebaseConfig.projectId === "your-project-id") {
                console.error("Firebase config is missing or using placeholder. Cannot initialize.");
                loadingMessage.classList.add('hidden');
                errorMessage.textContent = "خطأ في الاتصال: إعدادات Firebase مفقودة. يرجى التأكد من توفرها.";
                errorMessage.classList.remove('hidden');
                saveButton.disabled = true;
                return;
            }

            try {
                // Initialize services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Display App ID
                appIdDisplay.textContent = appId;

                loadingMessage.textContent = "جاري تسجيل الدخول (تسجيل دخول مجهول)...";

                // استخدام signInAnonymously() لضمان عمل المصادقة على GitHub Pages
                // ويستخدم signInWithCustomToken() في بيئة Canvas التلقائية
                let userCredential;
                if (initialAuthToken) {
                    userCredential = await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    userCredential = await signInAnonymously(auth);
                }
                
                currentUserId = userCredential.user.uid;
                userIdDisplay.textContent = currentUserId;
                userInfoSection.classList.remove('hidden');
                isAuthReady = true;

                loadingMessage.classList.add('hidden');
                saveButton.disabled = false;
                
                console.log("Firebase initialized and user signed in:", currentUserId);

                // Start listening for data changes
                setupRealtimeListener();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingMessage.classList.add('hidden');
                errorMessage.textContent = `خطأ في التهيئة: ${error.message}`;
                errorMessage.classList.remove('hidden');
                saveButton.disabled = true;
                showModal("خطأ في التهيئة", error.message, true); // Use modal for error
            }
        }

        // --- 2. FIREBASE FIRETORE PATH & SETUP ---

        // Function to get the correct document reference for private user data
        function getUserDocumentRef(userId) {
            // Path structure for the user's data: artifacts/{appId}/users/{userId}/my_user_data/profile
            const finalAppId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

            const collectionPath = `artifacts/${finalAppId}/users/${userId}/my_user_data`;
            const docId = 'profile'; // Using a fixed document ID for the user's profile
            return doc(db, collectionPath, docId);
        }

        // Function to save data to Firestore
        async function saveData() {
            if (!isAuthReady) return;

            const nameInput = document.getElementById('userName').value.trim();
            const emailInput = document.getElementById('userEmail').value.trim();

            if (!nameInput && !emailInput) {
                showModal("تنبيه", "الرجاء إدخال الاسم أو البريد الإلكتروني للحفظ."); // Use modal for validation
                return;
            }

            const profileData = {
                name: nameInput || "لم يتم تحديد اسم",
                email: emailInput || "لم يتم تحديد بريد إلكتروني",
                lastUpdated: new Date().toISOString()
            };

            const docRef = getUserDocumentRef(currentUserId);

            try {
                // setDoc will create the document if it doesn't exist, or overwrite it if it does
                await setDoc(docRef, profileData);
                console.log("Document successfully written!");
                saveButton.textContent = "تم الحفظ بنجاح! ✅";
                setTimeout(() => saveButton.textContent = "حفظ البيانات", 2000);
            } catch (e) {
                console.error("Error writing document: ", e);
                showModal("خطأ في الحفظ", `حدث خطأ أثناء حفظ البيانات: ${e.message}`, true); // Use modal for error
            }
        }

        // Function to set up a real-time listener for the saved data
        function setupRealtimeListener() {
            if (!isAuthReady) return;

            const docRef = getUserDocumentRef(currentUserId);

            // onSnapshot listens for real-time changes
            onSnapshot(docRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    console.log("Current data:", data);
                    
                    // Update the UI with the real-time data
                    savedNameDisplay.textContent = data.name || 'لا يوجد';
                    savedEmailDisplay.textContent = data.email || 'لا يوجد';
                    document.getElementById('userName').value = data.name || '';
                    document.getElementById('userEmail').value = data.email || '';
                } else {
                    console.log("No such document for this user!");
                    savedNameDisplay.textContent = '... لا يوجد بيانات ...';
                    savedEmailDisplay.textContent = '... لا يوجد بيانات ...';
                    // Clear inputs if data doesn't exist
                    document.getElementById('userName').value = '';
                    document.getElementById('userEmail').value = '';
                }
            }, (error) => {
                console.error("Firestore listener error:", error);
                errorMessage.textContent = `خطأ في الاستماع للبيانات: ${error.message}`;
                errorMessage.classList.remove('hidden');
                showModal("خطأ في الاستماع", `حدث خطأ أثناء تحديث البيانات: ${error.message}`, true);
            });
        }

        // Event Listeners
        saveButton.addEventListener('click', saveData);

        // Start the application
        initializeFirebase();
    </script>
</body>
</html>
