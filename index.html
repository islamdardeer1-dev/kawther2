<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سجل السكان - قاعدة بيانات سحابية</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ضبط الخط الافتراضي لـ Inter وتفعيل نمط RTL -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f7f9fb;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app-container" class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10 border border-gray-200">
        <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6 border-b-2 pb-3 border-indigo-100">سجل بيانات السكان</h1>

        <!-- معلومات المستخدم والتحميل -->
        <div id="status" class="mb-4 p-3 bg-blue-50 text-blue-800 rounded-lg text-sm border-l-4 border-blue-400">
            <p id="auth-status">جاري التحقق من حالة المستخدم...</p>
            <p id="user-id-display" class="mt-1 text-xs opacity-75"></p>
        </div>

        <!-- نموذج إضافة ساكن جديد -->
        <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">إضافة ساكن جديد</h2>
            <form id="add-resident-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="name-input" placeholder="الاسم الكامل" required
                       class="col-span-1 md:col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                
                <input type="tel" id="phone-input" placeholder="رقم الهاتف (مثال: 0501234567)" required pattern="[0-9]+"
                       class="col-span-1 md:col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                
                <button type="submit" id="submit-button" disabled
                        class="col-span-1 md:col-span-1 bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 disabled:bg-indigo-300 transition duration-200 shadow-md hover:shadow-lg">
                    إضافة الساكن
                </button>
            </form>
            <div id="form-message" class="mt-3 text-sm text-red-600 hidden"></div>
        </div>

        <!-- قائمة السكان -->
        <div class="mt-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 pb-2 border-b">السكان المسجلون (<span id="residents-count">0</span>)</h2>
            <div id="residents-list" class="space-y-3">
                <!-- سيتم عرض بيانات السكان هنا -->
                <p id="loading-list" class="text-center text-gray-500 mt-4">جاري تحميل البيانات...</p>
            </div>
            <p id="empty-list" class="text-center text-gray-500 mt-4 hidden">لا يوجد سكان مسجلون بعد. ابدأ بإضافة أول ساكن!</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // استيراد وظائف Firebase المطلوبة
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, setDoc, setLogLevel, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // **********************************************
        // 1. تهيئة وثوابت Firebase
        // **********************************************
        
        // استخدام متغيرات البيئة المتوفرة في Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // استخدام التهيئة التي قدمها المستخدم
        const customFirebaseConfig = {
            apiKey: "AIzaSyA3kHexcWgAh_7jqHbgWp-QX8Nj5bFb9s8",
            authDomain: "kawther2.firebaseapp.com",
            projectId: "kawther2",
            storageBucket: "kawther2.firebasestorage.app",
            messagingSenderId: "497467173741",
            appId: "1:497467173741:web:6450bd989d8ce273338864",
            measurementId: "G-W5LE13JCYG"
        };
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) : customFirebaseConfig;

        // تهيئة التطبيق وقاعدة البيانات والمصادقة
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // قم بتعيين مستوى تسجيل الدخول لتصحيح الأخطاء
        setLogLevel('Debug');

        let isAuthReady = false;
        let userId = null;
        let unsubscribe = null; // للاحتفاظ بوظيفة إلغاء الاشتراك في onSnapshot

        // العناصر الأساسية في DOM
        const form = document.getElementById('add-resident-form');
        const nameInput = document.getElementById('name-input');
        const phoneInput = document.getElementById('phone-input');
        const submitButton = document.getElementById('submit-button');
        const residentsList = document.getElementById('residents-list');
        const loadingList = document.getElementById('loading-list');
        const emptyList = document.getElementById('empty-list');
        const authStatus = document.getElementById('auth-status');
        const userIdDisplay = document.getElementById('user-id-display');
        const formMessage = document.getElementById('form-message');
        const residentsCount = document.getElementById('residents-count');

        // **********************************************
        // 2. وظائف مساعدة
        // **********************************************

        /**
         * بناء مسار مجموعة Firestore (لبيانات عامة/مشتركة)
         * @returns {string} المسار الكامل للمجموعة
         */
        function getCollectionPath() {
            // المسار العام: /artifacts/{appId}/public/data/{collectionName}
            return `artifacts/${appId}/public/data/residents`;
        }

        /**
         * عرض رسالة خطأ مؤقتة في النموذج
         * @param {string} message رسالة الخطأ
         */
        function showFormError(message) {
            formMessage.textContent = message;
            formMessage.classList.remove('hidden');
            setTimeout(() => {
                formMessage.classList.add('hidden');
            }, 5000);
        }

        // **********************************************
        // 3. المصادقة والاستماع لحالة المستخدم
        // **********************************************

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // المستخدم قام بتسجيل الدخول
                userId = user.uid;
                authStatus.textContent = 'تم تسجيل الدخول بنجاح.';
                userIdDisplay.textContent = `معرّف المستخدم: ${userId}`;
                isAuthReady = true;
                submitButton.disabled = false;
                
                // بدء الاستماع للبيانات بمجرد جاهزية المصادقة
                setupRealtimeListener();

            } else {
                // المستخدم غير مسجل الدخول، محاولة المصادقة
                authStatus.textContent = 'جاري تسجيل الدخول...';
                try {
                    if (initialAuthToken) {
                        // استخدام رمز مميز مخصص إذا كان متوفراً
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // تسجيل الدخول كمستخدم مجهول
                        const anonymousUser = await signInAnonymously(auth);
                        userId = anonymousUser.user.uid;
                        authStatus.textContent = 'تم تسجيل الدخول كمستخدم مجهول.';
                        userIdDisplay.textContent = `معرّف المستخدم: ${userId}`;
                        isAuthReady = true;
                        submitButton.disabled = false;
                        
                        // بدء الاستماع للبيانات بعد تسجيل الدخول
                        setupRealtimeListener();
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    authStatus.textContent = `فشل المصادقة: ${error.message}`;
                    userId = 'anonymous'; // تعيين معرف مؤقت
                    isAuthReady = true;
                    // لا يمكن التشغيل بدون مصادقة، إبقاء الزر معطلاً إذا كانت القاعدة تتطلب مصادقة
                    submitButton.disabled = true;
                }
            }
        });

        // **********************************************
        // 4. وظيفة الحذف
        // **********************************************
        
        /**
         * حذف سجل ساكن من Firestore
         * @param {string} docId معرّف المستند المراد حذفه
         */
        async function deleteResident(docId) {
            if (!isAuthReady) {
                showFormError("الرجاء الانتظار حتى يتم التحقق من حالة المصادقة.");
                return;
            }

            try {
                const docRef = doc(db, getCollectionPath(), docId);
                await deleteDoc(docRef);
                // لا حاجة لتحديث القائمة يدوياً، onSnapshot سيقوم بذلك
                console.log("Document successfully deleted!");
            } catch (error) {
                console.error("Error removing document: ", error);
                showFormError(`فشل حذف السجل: ${error.message}`);
            }
        }

        // **********************************************
        // 5. وظيفة عرض البيانات (onSnapshot)
        // **********************************************

        function renderResidents(residentsData) {
            residentsList.innerHTML = '';
            
            residentsCount.textContent = residentsData.length;

            if (residentsData.length === 0) {
                loadingList.classList.add('hidden');
                emptyList.classList.remove('hidden');
                return;
            }

            emptyList.classList.add('hidden');
            loadingList.classList.add('hidden');

            residentsData.forEach(resident => {
                const residentDiv = document.createElement('div');
                residentDiv.className = 'flex items-center justify-between p-4 bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition duration-200';
                residentDiv.innerHTML = `
                    <div>
                        <p class="text-lg font-medium text-gray-900">${resident.name}</p>
                        <p class="text-sm text-gray-500 dir-ltr">${resident.phone}</p>
                    </div>
                    <button data-id="${resident.id}" 
                            class="delete-btn bg-red-500 text-white p-2 rounded-full text-xs font-bold hover:bg-red-600 transition duration-150 shadow-sm"
                            title="حذف السجل">
                        حذف
                    </button>
                `;
                residentsList.appendChild(residentDiv);
            });

            // إضافة مستمعي الأحداث لأزرار الحذف
            residentsList.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.target.getAttribute('data-id');
                    
                    // تم إزالة window.confirm() لأنه لا يعمل في بيئة iframe.
                    // يتم الحذف مباشرة بعد الضغط على الزر.

                    // منع الضغطات المتعددة أثناء الحذف وعرض حالة مؤقتة
                    e.target.disabled = true;
                    e.target.textContent = '...';

                    deleteResident(docId);
                    
                    // ملاحظة: onSnapshot ستعيد بناء القائمة بالكامل، مما يعيد تفعيل الزر تلقائياً.
                });
            });
        }

        function setupRealtimeListener() {
            if (unsubscribe) {
                unsubscribe(); // إلغاء الاشتراك السابق إذا وجد
            }

            if (!isAuthReady) return;

            const residentsQuery = query(collection(db, getCollectionPath()));
            
            unsubscribe = onSnapshot(residentsQuery, (querySnapshot) => {
                const residents = [];
                querySnapshot.forEach((doc) => {
                    residents.push({ id: doc.id, ...doc.data() });
                });
                // فرز البيانات محلياً حسب الاسم
                residents.sort((a, b) => a.name.localeCompare(b.name, 'ar', { sensitivity: 'base' }));
                renderResidents(residents);
            }, (error) => {
                console.error("Error getting documents: ", error);
                loadingList.textContent = `حدث خطأ أثناء تحميل البيانات: ${error.message}`;
            });
        }


        // **********************************************
        // 6. معالج إرسال النموذج (Create)
        // **********************************************

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady) {
                showFormError("الرجاء الانتظار حتى يتم التحقق من حالة المصادقة قبل الإضافة.");
                return;
            }

            const name = nameInput.value.trim();
            const phone = phoneInput.value.trim();

            if (!name || !phone) {
                showFormError("يرجى إدخال كل من الاسم ورقم الهاتف.");
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'جاري الإضافة...';
            formMessage.classList.add('hidden');

            try {
                const newResident = {
                    name: name,
                    phone: phone,
                    createdAt: new Date().toISOString(),
                    // إضافة userId لتسهيل تتبع المنشئ (حتى لو كانت البيانات عامة)
                    createdBy: userId
                };

                // إضافة مستند جديد إلى مجموعة 'residents'
                const docRef = await addDoc(collection(db, getCollectionPath()), newResident);
                
                console.log("Document written with ID: ", docRef.id);
                
                // مسح حقول النموذج
                nameInput.value = '';
                phoneInput.value = '';
                
                // لا حاجة لتحديث القائمة يدوياً، onSnapshot سيقوم بذلك
            } catch (error) {
                console.error("Error adding document: ", error);
                showFormError(`فشل إضافة الساكن: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'إضافة الساكن';
            }
        });
    </script>
</body>
</html>
