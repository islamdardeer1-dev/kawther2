<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø¨Ø±Ø¬ 2 Ø§Ù„Ø£ÙˆÙ‚Ø§Ù - Ù†Ø¸Ø§Ù… Ø´Ø§Ù…Ù„</title>
    <!-- ØªØ­Ù…ÙŠÙ„ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ø¶Ø¨Ø· Ø§Ù„Ø®Ø· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù€ Inter ÙˆØªÙØ¹ÙŠÙ„ Ù†Ù…Ø· RTL -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900;950&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f7f9fb;
        }
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* ØªØµÙ…ÙŠÙ… Ø²Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù†Ø´Ø· - ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù€ text-lg Ùˆ font-extrabold */
        .tab-btn {
            @apply px-4 py-2 text-lg font-extrabold rounded-lg transition duration-200;
        }
        .tab-btn.active {
            @apply bg-indigo-600 text-white shadow-md;
        }
        .tab-btn:not(.active) {
            @apply text-indigo-700 bg-indigo-100 hover:bg-indigo-200;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app-container" class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-200">
        <h1 class="text-3xl font-extrabold text-center text-indigo-700 mb-6 border-b-4 pb-3 border-indigo-200">Ø¥Ø¯Ø§Ø±Ø© Ø¨Ø±Ø¬ 2 Ø§Ù„Ø£ÙˆÙ‚Ø§Ù</h1>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
        <!-- ØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡ Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚ -->
        <div id="status" class="mb-6 p-3 bg-blue-50 text-blue-800 rounded-xl text-sm border-l-4 border-blue-400 hidden">
            <p id="auth-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...</p>
            <p id="user-id-display" class="mt-1 text-xs opacity-75"></p>
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Navigation Tabs) -->
        <nav class="flex flex-wrap gap-2 md:gap-4 mb-8 justify-center border-b pb-4">
            <button data-view="residents" class="tab-btn active">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙƒØ§Ù†</button>
            <button data-view="expenses" class="tab-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
            <button data-view="revenues" class="tab-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</button>
            <button data-view="report" class="tab-btn">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠ</button>
        </nav>

        <!-- ******************************************** -->
        <!-- 1. Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙƒØ§Ù† (RESIDENTS VIEW) -->
        <!-- ******************************************** -->
        <div id="residents-view" class="view-container">
            <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø³Ø§ÙƒÙ† Ø¬Ø¯ÙŠØ¯ -->
            <div class="mb-10 p-6 bg-gray-50 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Ø¥Ø¶Ø§ÙØ© Ø³Ø§ÙƒÙ† Ø¬Ø¯ÙŠØ¯</h2>
                <form id="add-resident-form" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <input type="text" id="name-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required
                        class="col-span-2 md:col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    <input type="tel" id="phone-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required pattern="[0-9]+"
                        class="col-span-2 md:col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    <input type="number" id="apartment-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø´Ù‚Ø©" required min="1"
                        class="col-span-2 md:col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    <button type="submit" id="submit-button" disabled
                            class="col-span-2 md:col-span-1 bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 disabled:bg-indigo-300 transition duration-200 shadow-md hover:shadow-lg">
                        Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø§ÙƒÙ†
                    </button>
                </form>
                <div id="form-message" class="mt-3 text-sm text-red-600 hidden font-medium"></div>
            </div>

            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙƒØ§Ù† (Ø§Ù„ØªÙ‚Ø±ÙŠØ±) -->
            <div class="mt-10">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 pb-2 border-b">ØªÙ‚Ø±ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙƒØ§Ù† (<span id="residents-count">0</span>)</h2>
                
                <!-- Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Header) -->
                <div id="report-header" class="grid grid-cols-12 gap-2 text-sm font-bold text-gray-600 p-3 bg-gray-100 rounded-t-xl sticky top-0 border-b border-gray-300 hidden md:grid">
                    <div class="col-span-4">Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ù‡Ø§ØªÙ</div>
                    <div class="col-span-2 text-center">Ø§Ù„Ø´Ù‚Ø©</div>
                    <div class="col-span-2 text-center">Ø§Ù„Ø¯ÙˆØ±</div>
                    <div class="col-span-2 text-center">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„ / Ø§Ù„ØªØ­Ø¯ÙŠØ«</div>
                    <div class="col-span-2 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</div>
                </div>

                <div id="residents-list" class="space-y-3">
                    <p id="loading-list" class="text-center text-gray-500 mt-4 p-4 text-lg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                </div>
                <p id="empty-list" class="text-center text-gray-500 mt-4 hidden p-4 text-lg">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙƒØ§Ù† Ù…Ø³Ø¬Ù„ÙˆÙ† Ø¨Ø¹Ø¯.</p>
            </div>
        </div>

        <!-- ******************************************** -->
        <!-- 2. Ø¹Ø±Ø¶ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (EXPENSES VIEW) -->
        <!-- ******************************************** -->
        <div id="expenses-view" class="view-container hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 pb-2 border-b-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>
            <div class="p-6 bg-red-50 rounded-xl shadow-lg border border-red-200 mb-8">
                <form id="add-expense-form" class="grid grid-cols-2 md:grid-cols-4 gap-4 items-end">
                    
                    <input type="text" id="expense-description" placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ" required
                        class="col-span-2 md:col-span-1 p-3 border border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150">
                    
                    <input type="number" id="expense-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (ÙˆØ­Ø¯Ø© Ù†Ù‚Ø¯ÙŠØ©)" required min="0.01" step="0.01"
                        class="col-span-2 md:col-span-1 p-3 border border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150">

                    <input type="date" id="expense-date" required
                        class="col-span-2 md:col-span-1 p-3 border border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150">
                    
                    <button type="submit" id="expense-submit-button" disabled
                            class="col-span-2 md:col-span-1 bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-700 disabled:bg-red-300 transition duration-200 shadow-md">
                        Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ
                    </button>
                </form>
                <div id="expense-message" class="mt-3 text-sm text-red-600 hidden font-medium"></div>
            </div>

            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª -->
            <div class="mt-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (<span id="expenses-count">0</span>)</h3>
                <div id="expenses-list" class="space-y-3">
                    <p class="text-center text-gray-500 mt-4 p-4" id="loading-expenses">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª...</p>
                </div>
            </div>
        </div>

        <!-- ******************************************** -->
        <!-- 3. Ø¹Ø±Ø¶ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (REVENUES VIEW) -->
        <!-- ******************************************** -->
        <div id="revenues-view" class="view-container hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 pb-2 border-b-2">ØªØ³Ø¬ÙŠÙ„ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (ØªØ­ØµÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª)</h2>
            <div class="p-6 bg-green-50 rounded-xl shadow-lg border border-green-200 mb-8">
                <form id="add-revenue-form" class="grid grid-cols-2 md:grid-cols-5 gap-4 items-end">
                    
                    <select id="revenue-resident-id" required
                        class="col-span-2 md:col-span-1 p-3 border border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                        <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§ÙƒÙ†</option>
                        <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙƒØ§Ù† -->
                    </select>

                    <input type="number" id="revenue-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„" required min="0.01" step="0.01"
                        class="col-span-2 md:col-span-1 p-3 border border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                    
                    <input type="month" id="revenue-month-period" required title="Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø°ÙŠ ÙŠØ®ØµÙ‡ Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙØ¹"
                        class="col-span-2 md:col-span-1 p-3 border border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">

                    <input type="date" id="revenue-date" required title="ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ"
                        class="col-span-2 md:col-span-1 p-3 border border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                    
                    <button type="submit" id="revenue-submit-button" disabled
                            class="col-span-2 md:col-span-1 bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 disabled:bg-green-300 transition duration-200 shadow-md">
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯
                    </button>
                </form>
                <div id="revenue-message" class="mt-3 text-sm text-red-600 hidden font-medium"></div>
            </div>

            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª -->
            <div class="mt-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (<span id="revenues-count">0</span>)</h3>
                <div id="revenues-list" class="space-y-3">
                    <p class="text-center text-gray-500 mt-4 p-4" id="loading-revenues">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª...</p>
                </div>
            </div>
        </div>

        <!-- ******************************************** -->
        <!-- 4. Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠ (REPORT VIEW) -->
        <!-- ******************************************** -->
        <div id="report-view" class="view-container hidden">
            <h2 class="text-2xl font-extrabold text-indigo-700 mb-4 pb-2 border-b-2 border-indigo-200">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h2>
            
            <div class="bg-indigo-50 p-6 rounded-xl shadow-inner mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <label for="report-month-selector" class="text-lg font-semibold text-indigo-800">Ø§Ø®ØªØ± Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</label>
                    <input type="month" id="report-month-selector" required
                        class="p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="text-sm font-bold text-gray-700">
                    <p>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©: <span id="monthly-fee-display" class="text-green-600 text-lg">---</span></p>
                </div>
            </div>

            <div id="report-results" class="space-y-6">
                <p id="report-loading" class="text-center text-gray-500 p-8 text-xl hidden">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...</p>
                <div id="report-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù…Ù„Ø®Øµ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‡Ù†Ø§ -->
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ØªÙØ§ØµÙŠÙ„ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø³ÙƒØ§Ù† Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯</h3>
                    <div id="debt-report-list" class="space-y-3">
                        <p class="text-center text-gray-500 p-4">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø´Ù‡Ø± Ù„Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª.</p>
                    </div>
                </div>
            </div>
        </div>


    </div>
    
    <!-- Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ (Edit Modal) -->
    <div id="edit-modal" class="modal-overlay hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4 transform transition-all scale-100" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <h3 id="modal-title" class="text-xl font-bold text-indigo-700 mb-6 border-b pb-2">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§ÙƒÙ†</h3>
            <form id="edit-resident-form" class="space-y-4">
                
                <input type="hidden" id="edit-id">

                <div>
                    <label for="edit-name" class="block text-sm font-medium text-gray-700">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="edit-name" required
                           class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <div>
                    <label for="edit-phone" class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" id="edit-phone" required pattern="[0-9]+"
                           class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <div>
                    <label for="edit-apartment" class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„Ø´Ù‚Ø©</label>
                    <input type="number" id="edit-apartment" required min="1"
                           class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>
                <p id="edit-floor-display" class="text-sm text-indigo-600 font-bold">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ø­Ø³ÙˆØ¨: --</p>
                <div id="edit-message" class="text-sm text-red-600 font-medium hidden"></div>

                <div class="flex justify-end space-x-3 space-x-reverse pt-4">
                    <button type="button" id="close-modal-btn"
                            class="px-4 py-2 text-sm font-bold border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="submit" id="save-edit-btn"
                            class="px-4 py-2 text-sm font-bold bg-green-500 text-white rounded-lg hover:bg-green-600 transition duration-150 shadow-md">
                        Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ¸Ø§Ø¦Ù Firebase Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, setLogLevel, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // **********************************************
        // 1. ØªÙ‡ÙŠØ¦Ø© ÙˆØ«ÙˆØ§Ø¨Øª Firebase
        // **********************************************
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…ØªÙˆÙØ±Ø© ÙÙŠ Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªÙŠ Ù‚Ø¯Ù…Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const customFirebaseConfig = {
            apiKey: "AIzaSyA3kHexcWgAh_7jqHbgWp-QX8Nj5bFb9s8",
            authDomain: "kawther2.firebaseapp.com",
            projectId: "kawther2",
            storageBucket: "kawther2.firebasestorage.app",
            messagingSenderId: "497467173741",
            appId: "1:497467173741:web:6450bd989d8ce273338864",
            measurementId: "G-W5LE13JCYG"
        };
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) : customFirebaseConfig;

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªÙˆÙ‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        setLogLevel('Debug');

        let isAuthReady = false;
        let userId = null;
        let unsubscribeResidents = null;
        let unsubscribeExpenses = null;
        let unsubscribeRevenues = null;

        // Ø«ÙˆØ§Ø¨Øª ÙˆÙ…Ø®Ø§Ø²Ù† Ø¨ÙŠØ§Ù†Ø§Øª
        const SHAPPU_PER_FLOOR = 8; // Ø«Ø§Ø¨Øª Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯ÙˆØ±
        const MONTHLY_FEE = 100; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ (100 ÙˆØ­Ø¯Ø© Ù†Ù‚Ø¯ÙŠØ©)
        let allResidents = []; // Ù…Ø®Ø²Ù† Ù„Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙƒØ§Ù†
        let allExpenses = [];   // Ù…Ø®Ø²Ù† Ù„Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
        let allRevenues = [];  // Ù…Ø®Ø²Ù† Ù„Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
        let currentView = 'residents';

        // **********************************************
        // 2. Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙŠ DOM
        // **********************************************
        
        // Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        const viewContainers = {
            residents: document.getElementById('residents-view'),
            expenses: document.getElementById('expenses-view'),
            revenues: document.getElementById('revenues-view'),
            report: document.getElementById('report-view'),
        };
        const tabButtons = document.querySelectorAll('.tab-btn');

        // Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Ù…Ø®ÙÙŠØ© ÙÙŠ HTML)
        const statusDiv = document.getElementById('status'); 
        const authStatus = document.getElementById('auth-status');
        const userIdDisplay = document.getElementById('user-id-display');

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙƒØ§Ù† (Residents View)
        const form = document.getElementById('add-resident-form');
        const nameInput = document.getElementById('name-input');
        const phoneInput = document.getElementById('phone-input');
        const apartmentInput = document.getElementById('apartment-input'); 
        const submitButton = document.getElementById('submit-button');
        const residentsList = document.getElementById('residents-list');
        const loadingList = document.getElementById('loading-list');
        const emptyList = document.getElementById('empty-list');
        const formMessage = document.getElementById('form-message');
        const residentsCount = document.getElementById('residents-count');
        const reportHeader = document.getElementById('report-header'); 
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-resident-form');
        const editIdInput = document.getElementById('edit-id');
        const editNameInput = document.getElementById('edit-name');
        const editPhoneInput = document.getElementById('edit-phone');
        const editApartmentInput = document.getElementById('edit-apartment');
        const editFloorDisplay = document.getElementById('edit-floor-display');
        const editMessage = document.getElementById('edit-message');
        const closeEditModalBtn = document.getElementById('close-modal-btn');
        const saveEditBtn = document.getElementById('save-edit-btn');

        // Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Expenses View)
        const expenseForm = document.getElementById('add-expense-form');
        const expenseDescriptionInput = document.getElementById('expense-description');
        const expenseAmountInput = document.getElementById('expense-amount');
        const expenseDateInput = document.getElementById('expense-date');
        const expenseSubmitButton = document.getElementById('expense-submit-button');
        const expenseMessage = document.getElementById('expense-message');
        const expensesCount = document.getElementById('expenses-count');
        const expensesList = document.getElementById('expenses-list');
        const loadingExpenses = document.getElementById('loading-expenses');

        // Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Revenues View)
        const revenueForm = document.getElementById('add-revenue-form');
        const revenueResidentSelect = document.getElementById('revenue-resident-id');
        const revenueAmountInput = document.getElementById('revenue-amount');
        const revenueMonthPeriodInput = document.getElementById('revenue-month-period');
        const revenueDateInput = document.getElementById('revenue-date');
        const revenueSubmitButton = document.getElementById('revenue-submit-button');
        const revenueMessage = document.getElementById('revenue-message');
        const revenuesCount = document.getElementById('revenues-count');
        const revenuesList = document.getElementById('revenues-list');
        const loadingRevenues = document.getElementById('loading-revenues');

        // Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Report View)
        const monthlyFeeDisplay = document.getElementById('monthly-fee-display');
        const reportMonthSelector = document.getElementById('report-month-selector');
        const reportLoading = document.getElementById('report-loading');
        const reportSummary = document.getElementById('report-summary');
        const debtReportList = document.getElementById('debt-report-list');

        // **********************************************
        // 3. ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
        // **********************************************

        /**
         * Ø¨Ù†Ø§Ø¡ Ù…Ø³Ø§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Firestore (Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø§Ù…Ø©/Ù…Ø´ØªØ±ÙƒØ©)
         * @param {string} collectionName Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ('residents', 'expenses', 'revenues')
         * @returns {string} Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
         */
        function getCollectionPath(collectionName) {
            // Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¹Ø§Ù…: /artifacts/{appId}/public/data/{collectionName}
            return `artifacts/${appId}/public/data/${collectionName}`;
        }

        /**
         * Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…Ø¤Ù‚ØªØ© ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
         * @param {string} message Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
         * @param {HTMLElement} element Ø§Ù„Ø¹Ù†ØµØ± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠÙ‡
         */
        function showFormError(message, element) {
            element.textContent = message;
            element.classList.remove('hidden');
            // Ø¨Ù…Ø§ Ø£Ù† Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø®ÙÙŠØŒ Ù„Ù† ØªØ¸Ù‡Ø± Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø©
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        /**
         * ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† ISO string Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ù…Ø­Ù„ÙŠ Ù‚ØµÙŠØ±
         * @param {string} isoString
         * @returns {string}
         */
        function formatRegistrationDate(isoString) {
            if (!isoString) return 'N/A';
            try {
                const date = new Date(isoString);
                const options = { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    hour12: true, 
                    timeZoneName: 'short' 
                };
                return date.toLocaleTimeString('ar-EG', options);
            } catch (e) {
                return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­';
            }
        }
        
        /**
         * ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù„Øº (Ø¹Ù…Ù„Ø©)
         * @param {number} amount
         * @returns {string}
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-EG', { 
                style: 'decimal', 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            }).format(amount);
        }

        /**
         * ØªÙØ¹ÙŠÙ„ Ø¹Ø±Ø¶ Ù…Ø¹ÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø¶ØºÙˆØ·
         * @param {string} viewName Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ (residents, expenses, revenues, report)
         */
        function switchView(viewName) {
            currentView = viewName;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            Object.values(viewContainers).forEach(container => container.classList.add('hidden'));
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            if (viewContainers[viewName]) {
                viewContainers[viewName].classList.remove('hidden');
            }

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            tabButtons.forEach(btn => {
                if (btn.getAttribute('data-view') === viewName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            if (viewName === 'report') {
                const currentMonth = reportMonthSelector.value;
                if (currentMonth) {
                    generateMonthlyReport(currentMonth);
                }
            }
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => switchView(btn.getAttribute('data-view')));
        });


        // **********************************************
        // 4. Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        // **********************************************

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                authStatus.textContent = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.';
                userIdDisplay.textContent = `Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userId}`;
                isAuthReady = true;
                
                statusDiv.classList.remove('bg-red-100', 'text-red-800', 'border-red-500');
                statusDiv.classList.add('bg-blue-50', 'text-blue-800', 'border-blue-400');
                
                // ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                [submitButton, expenseSubmitButton, revenueSubmitButton].forEach(btn => btn.disabled = false);

                setupRealtimeListeners();
            } else {
                authStatus.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        const anonymousUser = await signInAnonymously(auth);
                        userId = anonymousUser.user.uid;
                        authStatus.textContent = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„.';
                        userIdDisplay.textContent = `Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userId}`;
                        isAuthReady = true;
                        
                        // ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                        [submitButton, expenseSubmitButton, revenueSubmitButton].forEach(btn => btn.disabled = false);
                        
                        setupRealtimeListeners();
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    statusDiv.classList.remove('bg-blue-50', 'text-blue-800', 'border-blue-400');
                    statusDiv.classList.add('bg-red-100', 'text-red-800', 'border-red-500');

                    authStatus.textContent = `ÙØ´Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ${error.message}`;
                    userId = 'anonymous';
                    isAuthReady = true;
                    // ØªØ¹Ø·ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯ ÙØ´Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                    [submitButton, expenseSubmitButton, revenueSubmitButton].forEach(btn => btn.disabled = true);
                }
            }
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„ØªÙ‚Ø±ÙŠØ± Ù„ÙŠÙƒÙˆÙ† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            reportMonthSelector.value = `${year}-${month}`;
            monthlyFeeDisplay.textContent = `${formatCurrency(MONTHLY_FEE)}`;
        });

        // **********************************************
        // 5. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firestore (CRUD & Listeners)
        // **********************************************

        /**
         * ÙˆØ¸ÙŠÙØ© ÙˆØ§Ø­Ø¯Ø© Ù„Ø¬Ù…Ø¹ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù€ Firestore
         */
        function setupRealtimeListeners() {
            if (!isAuthReady) return;

            // 5.1. Ù…Ø³ØªÙ…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙƒØ§Ù†
            if (unsubscribeResidents) unsubscribeResidents();
            const residentsQuery = query(collection(db, getCollectionPath('residents')));
            unsubscribeResidents = onSnapshot(residentsQuery, (querySnapshot) => {
                allResidents = [];
                querySnapshot.forEach((doc) => {
                    allResidents.push({ id: doc.id, ...doc.data() });
                });
                allResidents.sort((a, b) => (a.apartmentNumber || 0) - (b.apartmentNumber || 0));
                renderResidents(allResidents);
                populateResidentSelect(allResidents); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙƒØ§Ù† ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
                if (currentView === 'report' && reportMonthSelector.value) {
                    generateMonthlyReport(reportMonthSelector.value);
                }
            }, (error) => {
                console.error("Error getting residents: ", error);
                loadingList.textContent = `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙƒØ§Ù†: ${error.message}`;
            });

            // 5.2. Ù…Ø³ØªÙ…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
            if (unsubscribeExpenses) unsubscribeExpenses();
            const expensesQuery = query(collection(db, getCollectionPath('expenses')));
            unsubscribeExpenses = onSnapshot(expensesQuery, (querySnapshot) => {
                allExpenses = [];
                querySnapshot.forEach((doc) => {
                    allExpenses.push({ id: doc.id, ...doc.data() });
                });
                allExpenses.sort((a, b) => new Date(b.date) - new Date(a.date)); // ÙØ±Ø² Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø­Ø¯Ø«
                renderExpenses(allExpenses);
                if (currentView === 'report' && reportMonthSelector.value) {
                    generateMonthlyReport(reportMonthSelector.value);
                }
            }, (error) => {
                console.error("Error getting expenses: ", error);
                loadingExpenses.textContent = `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ${error.message}`;
            });

            // 5.3. Ù…Ø³ØªÙ…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
            if (unsubscribeRevenues) unsubscribeRevenues();
            const revenuesQuery = query(collection(db, getCollectionPath('revenues')));
            unsubscribeRevenues = onSnapshot(revenuesQuery, (querySnapshot) => {
                allRevenues = [];
                querySnapshot.forEach((doc) => {
                    allRevenues.push({ id: doc.id, ...doc.data() });
                });
                allRevenues.sort((a, b) => new Date(b.collectionDate) - new Date(a.collectionDate)); // ÙØ±Ø² Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø­Ø¯Ø«
                renderRevenues(allRevenues);
                if (currentView === 'report' && reportMonthSelector.value) {
                    generateMonthlyReport(reportMonthSelector.value);
                }
            }, (error) => {
                console.error("Error getting revenues: ", error);
                loadingRevenues.textContent = `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: ${error.message}`;
            });
        }

        // **********************************************
        // 6. ÙˆØ¸Ø§Ø¦Ù Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© (RENDER FUNCTIONS)
        // **********************************************

        // 6.1. Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙƒØ§Ù†
        function renderResidents(residentsData) {
            residentsList.innerHTML = '';
            residentsCount.textContent = residentsData.length;

            if (residentsData.length === 0) {
                loadingList.classList.add('hidden');
                emptyList.classList.remove('hidden');
                reportHeader.classList.add('hidden');
                return;
            }

            emptyList.classList.add('hidden');
            loadingList.classList.add('hidden');
            reportHeader.classList.remove('hidden');

            // ... (Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙƒØ§Ù† Ù„Ù… ÙŠØªØºÙŠØ± ÙƒØ«ÙŠØ±Ø§Ù‹ - ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡ Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)
            residentsData.forEach(resident => {
                const residentDiv = document.createElement('div');
                residentDiv.className = 'grid grid-cols-12 gap-2 items-center p-4 bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-lg transition duration-200 text-sm md:text-base';
                
                const displayISO = resident.updatedAt || resident.createdAt;
                const displayLabel = resident.updatedAt ? 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«' : 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
                const formattedDate = formatRegistrationDate(displayISO);
                const [datePart, timePart, ampmPart] = formattedDate.split(' ');


                residentDiv.innerHTML = `
                    <div class="col-span-12 md:col-span-4 flex flex-col">
                        <p class="text-base font-bold text-gray-900">${resident.name}</p>
                        <p class="text-xs text-gray-500 dir-ltr">${resident.phone}</p>
                    </div>
                    
                    <div class="col-span-6 md:col-span-2 text-center">
                        <span class="md:hidden font-semibold text-gray-600">Ø§Ù„Ø´Ù‚Ø©: </span>
                        <span class="font-bold text-lg text-indigo-800">${resident.apartmentNumber || 'N/A'}</span>
                    </div>

                    <div class="col-span-6 md:col-span-2 text-center">
                        <span class="md:hidden font-semibold text-gray-600">Ø§Ù„Ø¯ÙˆØ±: </span>
                        <span class="font-bold text-md text-indigo-600">${resident.floorNumber || 'N/A'}</span>
                    </div>
                    
                    <div class="hidden md:flex md:col-span-2 text-center justify-center items-center flex-col">
                        <span class="text-xs font-semibold text-gray-700 mb-1">${displayLabel}</span>
                        <span class="text-xs text-gray-500">${datePart}</span>
                        <span class="text-xs text-gray-500">${timePart} ${ampmPart}</span>
                    </div>

                    <div class="col-span-12 md:col-span-2 flex justify-center space-x-2 space-x-reverse mt-2 md:mt-0">
                        <button data-id="${resident.id}" 
                                data-name="${resident.name}"
                                data-phone="${resident.phone}"
                                data-apartment="${resident.apartmentNumber}"
                                data-floor="${resident.floorNumber}"
                                class="edit-btn bg-blue-500 text-white p-2 rounded-lg text-xs font-bold hover:bg-blue-600 transition duration-150 shadow-sm w-16">
                            ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        <button data-id="${resident.id}" 
                                class="delete-btn bg-red-500 text-white p-2 rounded-lg text-xs font-bold hover:bg-red-600 transition duration-150 shadow-sm w-16">
                            Ø­Ø°Ù
                        </button>
                    </div>
                `;
                residentsList.appendChild(residentDiv);
            });

            residentsList.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.target.getAttribute('data-id');
                    e.target.disabled = true;
                    e.target.textContent = '...';
                    deleteItem(docId, 'residents');
                });
            });

            residentsList.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const residentData = {
                        id: e.target.getAttribute('data-id'),
                        name: e.target.getAttribute('data-name'),
                        phone: e.target.getAttribute('data-phone'),
                        apartmentNumber: parseInt(e.target.getAttribute('data-apartment'), 10),
                        floorNumber: parseInt(e.target.getAttribute('data-floor'), 10),
                    };
                    openEditModal(residentData);
                });
            });
        }
        
        // 6.2. ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙƒØ§Ù† ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
        function populateResidentSelect(residentsData) {
            revenueResidentSelect.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§ÙƒÙ†</option>';
            residentsData.forEach(resident => {
                const option = document.createElement('option');
                option.value = resident.id;
                option.textContent = `${resident.name} (Ø´Ù‚Ø©: ${resident.apartmentNumber})`;
                revenueResidentSelect.appendChild(option);
            });
        }

        // 6.3. Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
        function renderExpenses(expensesData) {
            expensesList.innerHTML = '';
            expensesCount.textContent = expensesData.length;

            if (expensesData.length === 0) {
                loadingExpenses.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¬Ù„Ø©.';
                return;
            }
            loadingExpenses.classList.add('hidden');

            expensesData.forEach(expense => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'grid grid-cols-12 gap-2 items-center p-3 bg-white rounded-lg shadow-sm border border-gray-100';
                
                itemDiv.innerHTML = `
                    <div class="col-span-6 md:col-span-4 font-bold text-gray-900">${expense.description}</div>
                    <div class="col-span-6 md:col-span-3 text-red-600 font-extrabold text-lg dir-ltr text-left">-${formatCurrency(expense.amount)}</div>
                    <div class="col-span-12 md:col-span-3 text-sm text-gray-500">ØªØ§Ø±ÙŠØ® Ø§Ù„ØµØ±Ù: ${expense.date}</div>
                    <div class="col-span-12 md:col-span-2 flex justify-end">
                        <button data-id="${expense.id}" 
                                class="delete-expense-btn bg-red-100 text-red-700 p-1 rounded text-xs hover:bg-red-200 transition duration-150">
                            Ø­Ø°Ù
                        </button>
                    </div>
                `;
                expensesList.appendChild(itemDiv);
            });

            expensesList.querySelectorAll('.delete-expense-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.target.getAttribute('data-id');
                    deleteItem(docId, 'expenses');
                });
            });
        }

        // 6.4. Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
        function renderRevenues(revenuesData) {
            revenuesList.innerHTML = '';
            revenuesCount.textContent = revenuesData.length;

            if (revenuesData.length === 0) {
                loadingRevenues.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…Ø³Ø¬Ù„Ø©.';
                return;
            }
            loadingRevenues.classList.add('hidden');

            revenuesData.forEach(revenue => {
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø³Ø§ÙƒÙ†
                const resident = allResidents.find(r => r.id === revenue.residentId);
                const residentName = resident ? resident.name : 'Ø³Ø§ÙƒÙ† Ù…Ø­Ø°ÙˆÙ';

                const itemDiv = document.createElement('div');
                itemDiv.className = 'grid grid-cols-12 gap-2 items-center p-3 bg-white rounded-lg shadow-sm border border-gray-100';
                
                itemDiv.innerHTML = `
                    <div class="col-span-12 md:col-span-3 font-bold text-gray-900">${residentName}</div>
                    <div class="col-span-6 md:col-span-2 text-green-600 font-extrabold text-lg dir-ltr text-left">+${formatCurrency(revenue.amount)}</div>
                    <div class="col-span-6 md:col-span-3 text-sm text-gray-500">ÙŠØ®Øµ Ø´Ù‡Ø±: ${revenue.monthPeriod}</div>
                    <div class="col-span-12 md:col-span-2 text-sm text-gray-500">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ØµÙŠÙ„: ${revenue.collectionDate}</div>
                    <div class="col-span-12 md:col-span-2 flex justify-end">
                        <button data-id="${revenue.id}" 
                                class="delete-revenue-btn bg-red-100 text-red-700 p-1 rounded text-xs hover:bg-red-200 transition duration-150">
                            Ø­Ø°Ù
                        </button>
                    </div>
                `;
                revenuesList.appendChild(itemDiv);
            });
            
            revenuesList.querySelectorAll('.delete-revenue-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.target.getAttribute('data-id');
                    deleteItem(docId, 'revenues');
                });
            });
        }


        // **********************************************
        // 7. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
        // **********************************************

        /**
         * Ø­Ø°Ù Ø³Ø¬Ù„ Ù…Ù† Ø£ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©
         * @param {string} docId Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯
         * @param {string} collectionName Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
         */
        async function deleteItem(docId, collectionName) {
            if (!isAuthReady) {
                showFormError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©.", formMessage); // Ø§Ø³ØªØ®Ø¯Ø§Ù… formMessage ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
                return;
            }

            try {
                const docRef = doc(db, getCollectionPath(collectionName), docId);
                await deleteDoc(docRef);
                console.log(`Document from ${collectionName} successfully deleted!`);
            } catch (error) {
                console.error(`Error removing document from ${collectionName}: `, error);
                showFormError(`ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„: ${error.message}`, formMessage);
            }
        }

        /**
         * ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§ÙƒÙ†
         */
        function openEditModal(residentData) {
            editIdInput.value = residentData.id;
            editNameInput.value = residentData.name;
            editPhoneInput.value = residentData.phone;
            editApartmentInput.value = residentData.apartmentNumber;
            editFloorDisplay.textContent = `Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ø­Ø³ÙˆØ¨: ${residentData.floorNumber}`;
            editMessage.classList.add('hidden');
            editModal.classList.remove('hidden');
        }

        editApartmentInput.addEventListener('input', () => {
            const apartmentNumber = parseInt(editApartmentInput.value, 10);
            if (apartmentNumber > 0) {
                const floorNumber = Math.ceil(apartmentNumber / SHAPPU_PER_FLOOR);
                editFloorDisplay.textContent = `Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ø­Ø³ÙˆØ¨: ${floorNumber}`;
            } else {
                editFloorDisplay.textContent = `Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ø­Ø³ÙˆØ¨: --`;
            }
        });

        closeEditModalBtn.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        // ğŸŸ¢ğŸŸ¢ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø°ÙŠ ÙŠØ¶Ù…Ù† Ø¹Ø¯Ù… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… updateDoc) ğŸŸ¢ğŸŸ¢
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const docId = editIdInput.value;
            const name = editNameInput.value.trim();
            const phone = editPhoneInput.value.trim();
            const apartmentNumber = parseInt(editApartmentInput.value, 10);

            if (!name || !phone || isNaN(apartmentNumber) || apartmentNumber < 1) {
                editMessage.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.";
                editMessage.classList.remove('hidden');
                return;
            }

            saveEditBtn.disabled = true;
            saveEditBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
            editMessage.classList.add('hidden');

            const floorNumber = Math.ceil(apartmentNumber / SHAPPU_PER_FLOOR);

            try {
                const docRef = doc(db, getCollectionPath('residents'), docId);
                
                // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… updateDoc Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø²Ø¦ÙŠ.
                // Ù‡Ø°Ø§ ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ„ Ù…Ø«Ù„ createdAt Ùˆ createdBy.
                await updateDoc(docRef, {
                    name: name,
                    phone: phone,
                    apartmentNumber: apartmentNumber,
                    floorNumber: floorNumber,
                    updatedAt: new Date().toISOString()
                });

                console.log("Resident document successfully updated (Partial Update enforced by updateDoc)!");
                editModal.classList.add('hidden');
            } catch (error) {
                console.error("Error updating resident document: ", error);
                editMessage.textContent = `ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª: ${error.message}`;
                editMessage.classList.remove('hidden');
            } finally {
                saveEditBtn.disabled = false;
                saveEditBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
            }
        });


        // **********************************************
        // 8. Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (CREATE)
        // **********************************************

        // 8.1. Ø¥Ø¶Ø§ÙØ© Ø³Ø§ÙƒÙ† Ø¬Ø¯ÙŠØ¯
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady) { showFormError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.", formMessage); return; }

            const name = nameInput.value.trim();
            const phone = phoneInput.value.trim();
            const apartmentNumber = parseInt(apartmentInput.value.trim(), 10);
            
            if (!name || !phone || isNaN(apartmentNumber) || apartmentNumber < 1) {
                showFormError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.", formMessage);
                return;
            }

            const floorNumber = Math.ceil(apartmentNumber / SHAPPU_PER_FLOOR); 
            submitButton.disabled = true;
            submitButton.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...';
            formMessage.classList.add('hidden');

            try {
                const newResident = {
                    name: name,
                    phone: phone,
                    apartmentNumber: apartmentNumber, 
                    floorNumber: floorNumber,         
                    createdAt: new Date().toISOString(),
                    createdBy: userId
                };

                // Ø§Ø³ØªØ®Ø¯Ø§Ù… addDoc ÙŠÙ†Ø´Ø¦ Ù…Ø³ØªÙ†Ø¯Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© ÙÙ‚Ø·.
                await addDoc(collection(db, getCollectionPath('residents')), newResident);
                
                nameInput.value = '';
                phoneInput.value = '';
                apartmentInput.value = '';
                
            } catch (error) {
                console.error("Error adding resident document: ", error);
                showFormError(`ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø§ÙƒÙ†: ${error.message}`, formMessage);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø§ÙƒÙ†';
            }
        });

        // 8.2. Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯
        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) { showFormError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.", expenseMessage); return; }

            const description = expenseDescriptionInput.value.trim();
            const amount = parseFloat(expenseAmountInput.value);
            const date = expenseDateInput.value;
            
            if (!description || isNaN(amount) || amount <= 0 || !date) {
                showFormError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ ÙˆÙ…Ø¨Ù„Øº Ù…ÙˆØ¬Ø¨ ÙˆØªØ§Ø±ÙŠØ®.", expenseMessage);
                return;
            }

            expenseSubmitButton.disabled = true;
            expenseSubmitButton.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...';
            expenseMessage.classList.add('hidden');

            try {
                const newExpense = {
                    description: description,
                    amount: amount,
                    date: date, // YYYY-MM-DD
                    createdAt: new Date().toISOString(),
                    createdBy: userId
                };

                await addDoc(collection(db, getCollectionPath('expenses')), newExpense);
                
                expenseDescriptionInput.value = '';
                expenseAmountInput.value = '';
                expenseDateInput.value = '';
                
            } catch (error) {
                console.error("Error adding expense document: ", error);
                showFormError(`ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ: ${error.message}`, expenseMessage);
            } finally {
                expenseSubmitButton.disabled = false;
                expenseSubmitButton.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ';
            }
        });

        // 8.3. Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ±Ø§Ø¯ Ø¬Ø¯ÙŠØ¯
        revenueForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) { showFormError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.", revenueMessage); return; }

            const residentId = revenueResidentSelect.value;
            const amount = parseFloat(revenueAmountInput.value);
            const monthPeriod = revenueMonthPeriodInput.value;
            const collectionDate = revenueDateInput.value;

            if (!residentId || isNaN(amount) || amount <= 0 || !monthPeriod || !collectionDate) {
                showFormError("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø§ÙƒÙ† ÙˆØ¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº Ù…ÙˆØ¬Ø¨ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø± ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ØµÙŠÙ„.", revenueMessage);
                return;
            }

            const resident = allResidents.find(r => r.id === residentId);
            const residentName = resident ? resident.name : 'Ø³Ø§ÙƒÙ† ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

            revenueSubmitButton.disabled = true;
            revenueSubmitButton.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...';
            revenueMessage.classList.add('hidden');

            try {
                const newRevenue = {
                    residentId: residentId,
                    residentName: residentName,
                    amount: amount,
                    monthPeriod: monthPeriod, // YYYY-MM
                    collectionDate: collectionDate, // YYYY-MM-DD (ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ)
                    createdAt: new Date().toISOString(),
                    createdBy: userId
                };

                await addDoc(collection(db, getCollectionPath('revenues')), newRevenue);
                
                revenueResidentSelect.value = '';
                revenueAmountInput.value = '';
                revenueMonthPeriodInput.value = '';
                revenueDateInput.value = '';
                
            } catch (error) {
                console.error("Error adding revenue document: ", error);
                showFormError(`ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯: ${error.message}`, revenueMessage);
            } finally {
                revenueSubmitButton.disabled = false;
                revenueSubmitButton.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯';
            }
        });


        // **********************************************
        // 9. ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠ (REPORTING)
        // **********************************************

        reportMonthSelector.addEventListener('change', (e) => {
            generateMonthlyReport(e.target.value);
        });

        function generateMonthlyReport(monthPeriod) {
            if (!isAuthReady) return;

            reportLoading.classList.remove('hidden');
            reportSummary.innerHTML = '';
            debtReportList.innerHTML = '';

            // 1. ØªØµÙÙŠØ© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ (YYYY-MM)
            const filteredExpenses = allExpenses.filter(e => e.date.substring(0, 7) === monthPeriod);
            const filteredRevenues = allRevenues.filter(r => r.monthPeriod === monthPeriod);

            // 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹
            const totalExpenses = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
            const totalRevenues = filteredRevenues.reduce((sum, r) => sum + r.amount, 0);
            const netBalance = totalRevenues - totalExpenses;

            // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ
            renderSummary(totalRevenues, totalExpenses, netBalance, monthPeriod);

            // 4. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ù„ÙƒÙ„ Ø³Ø§ÙƒÙ†
            calculateDebt(monthPeriod, filteredRevenues);

            reportLoading.classList.add('hidden');
        }

        /**
         * Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨
         */
        function renderSummary(revenues, expenses, net, month) {
            const monthName = new Date(month).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long' });
            
            const cards = [
                { title: `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙÙŠ ${monthName}`, amount: revenues, color: 'green', icon: 'ğŸ’°' },
                { title: `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙÙŠ ${monthName}`, amount: expenses, color: 'red', icon: 'ğŸ’¸' },
                { title: `ØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨`, amount: net, color: net >= 0 ? 'indigo' : 'red', icon: net >= 0 ? 'âœ…' : 'ğŸš¨' }
            ];

            reportSummary.innerHTML = cards.map(card => `
                <div class="bg-${card.color}-100 p-5 rounded-xl shadow-lg border border-${card.color}-200 flex flex-col items-center text-center">
                    <p class="text-xs font-semibold text-${card.color}-700 mb-2">${card.title}</p>
                    <p class="text-3xl font-extrabold text-${card.color}-800 dir-ltr flex items-center">
                        ${card.icon} ${formatCurrency(card.amount)}
                    </p>
                </div>
            `).join('');
        }

        /**
         * Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø³ÙƒØ§Ù†
         */
        function calculateDebt(monthPeriod, filteredRevenues) {
            if (allResidents.length === 0) {
                debtReportList.innerHTML = '<p class="text-center text-gray-500 p-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙƒØ§Ù† Ù…Ø³Ø¬Ù„ÙˆÙ† Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©.</p>';
                return;
            }

            const monthName = new Date(monthPeriod).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long' });
            debtReportList.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©

            const residentPayments = filteredRevenues.reduce((acc, rev) => {
                acc[rev.residentId] = (acc[rev.residentId] || 0) + rev.amount;
                return acc;
            }, {});

            allResidents.forEach(resident => {
                const totalDue = MONTHLY_FEE;
                const totalPaid = residentPayments[resident.id] || 0;
                const outstandingDebt = totalDue - totalPaid;

                const debtColor = outstandingDebt > 0 ? 'red' : (outstandingDebt < 0 ? 'blue' : 'green');
                const statusText = outstandingDebt > 0 ? `Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©: ${formatCurrency(outstandingDebt)}` : 
                                   (outstandingDebt < 0 ? `Ø¯ÙØ¹ Ø²Ø§Ø¦Ø¯: ${formatCurrency(Math.abs(outstandingDebt))}` : 'ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„');

                const itemDiv = document.createElement('div');
                itemDiv.className = `grid grid-cols-12 gap-2 items-center p-4 bg-white rounded-xl shadow-sm border border-${debtColor}-100`;
                
                itemDiv.innerHTML = `
                    <div class="col-span-12 md:col-span-4 font-bold text-gray-900">${resident.name} (Ø´Ù‚Ø©: ${resident.apartmentNumber})</div>
                    
                    <div class="col-span-4 md:col-span-2 text-center text-sm">
                        <span class="md:hidden font-semibold text-gray-600">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: </span>
                        <span class="text-sm font-medium text-gray-700">${formatCurrency(totalDue)}</span>
                    </div>

                    <div class="col-span-4 md:col-span-2 text-center text-sm">
                        <span class="md:hidden font-semibold text-gray-600">Ø§Ù„Ù…Ø³Ø¯Ø¯: </span>
                        <span class="text-sm font-medium text-green-600">${formatCurrency(totalPaid)}</span>
                    </div>

                    <div class="col-span-12 md:col-span-4 text-center text-lg font-extrabold text-${debtColor}-700">
                        ${statusText}
                    </div>
                `;
                debtReportList.appendChild(itemDiv);
            });
        }
    </script>
</body>
</html>
